import fs from "fs/promises";
import path from "path";
import { fileURLToPath, pathToFileURL } from "url";

import cv from "../src/data/cv.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, "..");

const portfolioFilePath = path.join(rootDir, "src/data/portfolio.js");
const portfolioSource = await fs.readFile(portfolioFilePath, "utf8");

const importRegex = /import\s+(\w+)\s+from\s+"@\/data\/portfolio\/items\/([^"]+)";/g;
const importMap = new Map();
let match = null;

while ((match = importRegex.exec(portfolioSource)) !== null) {
  importMap.set(match[1], match[2]);
}

const arrayMatch = portfolioSource.match(
  /const\s+portfolioItems\s*=\s*\[([\s\S]*?)\];/,
);
const orderedKeys = arrayMatch
  ? arrayMatch[1]
      .split(",")
      .map((item) => item.trim())
      .filter(Boolean)
  : [];

const projects = [];
for (const key of orderedKeys) {
  const relPath = importMap.get(key);
  if (!relPath) {
    continue;
  }
  const absolutePath = path.join(
    rootDir,
    "src/data/portfolio/items",
    `${relPath}.js`,
  );
  const module = await import(pathToFileURL(absolutePath).href);
  projects.push(module.default ?? module);
}

const payload = {
  generatedAt: new Date().toISOString(),
  cv,
  projects,
};

const outputPath = path.join(rootDir, "ai-context.js");
const output = `// Generated by scripts/export-ai-context.mjs. Do not edit by hand.\n\nconst data = ${JSON.stringify(
  payload,
  null,
  2,
)};\n\nexport default data;\n`;

await fs.writeFile(outputPath, output);

console.log(`Wrote ${projects.length} projects to ${outputPath}`);
